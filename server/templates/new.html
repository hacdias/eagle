{{ template "_header.html" . }}
{{ template "_navigation.html" "new" }}

<style>
#tags {
  padding: 0.25rem;
  margin: 0.5rem 0;
  width: 100%;
  border: 1px solid var(--accent);
  border-radius: 5px;
  color: var(--text);
  outline: 0;
  min-width: 0;
  background: var(--input-background);
  display: flex;
}

#tags span {
  background-color: var(--accent);
  color: var(--accent-text);
  padding: 0.25rem;
  margin-right: 0.25rem;
  white-space: nowrap;
  cursor: pointer;
  border-radius: 5px;
}

#tags #tag-input {
  margin: 0;
  padding: 0.25rem;
  border: 0;
}

#photos-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  grid-gap: 0.5rem;
}

#photos-list fieldset button {
  width: 100%;
}

#photos-list img {
  object-fit: cover;
  width: 100%;
  height: 10rem;
}
</style>

<h2>New Post</h2>

<form method='post'>
  <input name='title' placeholder='The Wise Words' required />
  <input name='slug' placeholder='wise-words' required />
  <textarea name='content' style='min-height: 50vh' placeholder='Once upon a time...' required></textarea>

  <fieldset>
    <legend>Tags</legend>
    <div id='tags'>
      <input type='text' placeholder='New tag...' id='tag-input' />
    </div>
  </fieldset>

  <fieldset>
    <legend>Category</legend>
    <ol class='options-list horizontal'>
      {{ range .Categories }}
        <li><label><input type='radio' name='category' value='{{ .UID }}' /> {{ .Name }}</label></li>
      {{ end }}
    </ol>
  </fieldset>

  <fieldset id='photos'>
    <legend>Photos</legend>
    <div id='photos-list'></div>
    <input type="file" id="photos-input" accept="image/*" style="display: none" />
    <button type='button' id='photos-add-button'>Add</button>
  </fieldset>

  <fieldset>
    <legend>Location</legend>
    <input name='location' placeholder='Location' placeholder='geo:...' />
    <button type='button' id='location-update-button'>Refresh</button>
  </fieldset>

  {{ template "_syndicators.html" .Syndicators }}

  <button>Create</button>
</form>

<script>
const locationInput = document.querySelector("input[name='location']")
const locationUpdateButton = document.getElementById('location-update-button')
const photosInput = document.getElementById('photos-input')
const photosAddButton = document.getElementById('photos-add-button')
const photosList = document.getElementById('photos-list')
const tagInput = document.getElementById('tag-input')

function updateLocation() {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const latitude = Math.round(pos.coords.latitude * 100000) / 100000
      const longitude = Math.round(pos.coords.longitude * 100000) / 100000
      const accuracy = Math.round(pos.coords.accuracy * 100000) / 100000
      const geo = `geo:${latitude},${longitude};u=${accuracy}`
      locationInput.value = geo
    },
    (err) => {
      if (err.code === 1) {
        alert('The website was not able to get permission')
      } else if (err.code === 2) {
        alert('Location information was unavailable')
      } else if (err.code === 3) {
        alert('Timed out getting location')
      }
    },
  )
}

function reindexPhotos() {
  const fieldsets = photosList.querySelectorAll('fieldset')
  fieldsets.forEach((fieldset, index) => {
    const urlInput = fieldset.querySelector('input[type="hidden"]')
    const titleInput = fieldset.querySelector('input[type="text"]')
    urlInput.name = `photos[${index}].url`
    titleInput.name = `photos[${index}].title`
  })
}

function createPhotoFieldset(file, url) {
  const fieldset = document.createElement('fieldset')

  const urlInput = document.createElement('input')
  urlInput.type = 'hidden'
  urlInput.value = url

  const preview = document.createElement('img')
  preview.src = window.URL.createObjectURL(file)

  const titleInput = document.createElement('input')
  titleInput.type = 'text'
  titleInput.placeholder = 'Title'

  const removeButton = document.createElement('button')
  removeButton.type = 'button'
  removeButton.textContent = 'Remove'
  removeButton.addEventListener('click', () => {
    fieldset.remove()
    reindexPhotos()
  })

  fieldset.appendChild(preview)
  fieldset.appendChild(urlInput)
  fieldset.appendChild(titleInput)
  fieldset.appendChild(removeButton)

  return fieldset
}

photosAddButton.addEventListener('click', () => {
  photosInput.click()
})

photosInput.addEventListener('change', async () => {
  const files = photosInput.files

  if (files.length !== 1) {
    return
  }

  const formData = new FormData()
  formData.set('file', files[0])

  const response = await fetch('/panel/cache', {
    method: 'POST',
    body: formData,
  })

  if (!response.ok) {
    alert('Failed to upload photo')
    return
  }

  const url = await response.text()
  const fieldset = createPhotoFieldset(files[0], url)
  photosList.appendChild(fieldset)
  reindexPhotos()

  photosInput.value = ''
})

locationUpdateButton.addEventListener('click', updateLocation)

tagInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' || e.key === 'Tab') {
    e.preventDefault()

    const value = e.target.value.trim()

    const input = document.createElement('input')
    input.name = 'tags'
    input.type = 'hidden'
    input.value = value

    const span = document.createElement('span')
    span.textContent = value
    span.addEventListener('click', () => {
      span.remove()
      input.remove()
    })

    document.getElementById('tags').insertBefore(span, e.target)
    document.getElementById('tags').insertBefore(input, e.target)

    e.target.value = ''
  }
})

document.addEventListener('DOMContentLoaded', () => {
  updateLocation()
})
</script>

{{ template "_footer.html" . }}
